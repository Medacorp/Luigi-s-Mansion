execute store result score #temp ID run data get storage luigis_mansion:data dialogs[0].scanning_player
execute as @e[tag=player] if score @s ID = #temp ID run tag @s add scanning_player
scoreboard players reset #temp ID
function luigis_mansion:dialog/play/scan/get_scanned_entity with storage luigis_mansion:data dialogs[0]

execute if score #dialog Dialog matches 2..3 if entity @a[tag=same_room,tag=next_dialog_line,limit=1] run scoreboard players add #dialog Dialog 1
execute if score #dialog Dialog matches ..1 run scoreboard players add #dialog Dialog 1
execute if entity @a[tag=same_room,tag=skip_dialog,limit=1] run scoreboard players set #dialog Dialog 4
execute if score #dialog Dialog matches 2..3 as @a[tag=same_room,tag=!spectator,tag=!dialog_menu,tag=!using_selection_menu] run function luigis_mansion:selection_menu/dialog/original_menu
execute if score #dialog Dialog matches 4.. as @a[tag=same_room,tag=dialog_menu] run function luigis_mansion:selection_menu/dialog/exit

scoreboard players reset @a[tag=same_room,tag=!spectator] WarpTime
tag @a[tag=scanning_player,limit=1] add prevent_item_lock
# 1 tick delay for scanned player to get the undisturbed state
execute if score #dialog Dialog matches 1 as @a[tag=same_room,tag=!spectator,tag=game_boy_horror_menu,tag=!scanning_player,tag=!scanned_entity] run function luigis_mansion:selection_menu/game_boy_horror/exit
execute if score #dialog Dialog matches 2..3 as @a[tag=same_room,tag=!spectator,tag=game_boy_horror_menu] run function luigis_mansion:selection_menu/game_boy_horror/exit
execute if score #dialog Dialog matches 1..3 as @e[tag=luigi,tag=!scanning_player,tag=same_room] run function luigis_mansion:entities/luigi/animation/set/idle_no_poltergust
execute if score #dialog Dialog matches 1..3 as @e[tag=luigi,tag=scanning_player,limit=1] run function luigis_mansion:entities/luigi/animation/set/game_boy_horror
execute as @a[tag=scanning_player,limit=1] run function luigis_mansion:items/game_boy_horror/turn_screen_to_forced_value {value:"scanning",flags:[1b,0b],floats:[],tracker:[]}
execute if score #dialog Dialog matches 1 at @a[tag=scanning_player,limit=1] at @e[tag=scanned_entity,scores={Health=51..},tag=!flashlight_selected,tag=!catch_portrait_ghost,tag=!catch_ghost,tag=!game_boy_horror_selected,tag=!game_boy_horror_menu,distance=1.5..,limit=1] positioned ~ ~-1.4 ~ unless entity @e[distance=..5,tag=item,nbt={data:{item:{namespace:"luigis_mansion",id:"gold_coin"}}},limit=1] store result score #temp Variant run random value 1..3
execute if score #dialog Dialog matches 1 if score #temp Variant matches 1 run tellraw @a[tag=same_room] {type:"translatable",translate:"chat.type.text",with:[{type:"selector",selector:"@a[tag=scanning_player,limit=1]",color:"green"},{type:"translatable",translate:"luigis_mansion:message.player.scan_furniture.113",with:[{type:"nbt",entity:"@e[tag=scanned_entity,limit=1]",nbt:"data.player_name"}]}]}
execute if score #dialog Dialog matches 1 if score #temp Variant matches 2 run tellraw @a[tag=same_room] {type:"translatable",translate:"chat.type.text",with:[{type:"selector",selector:"@a[tag=scanning_player,limit=1]",color:"green"},{type:"translatable",translate:"luigis_mansion:message.player.scan_furniture.114",with:[{type:"nbt",entity:"@e[tag=scanned_entity,limit=1]",nbt:"data.player_name"}]}]}
execute if score #dialog Dialog matches 1 at @a[tag=scanning_player,limit=1] at @e[tag=scanned_entity,scores={Health=51..},tag=!flashlight_selected,tag=!catch_portrait_ghost,tag=!catch_ghost,tag=!game_boy_horror_selected,tag=!game_boy_horror_menu,distance=..1.5,limit=1] positioned ~ ~-1.4 ~ unless entity @e[distance=..5,tag=item,nbt={data:{item:{namespace:"luigis_mansion",id:"gold_coin"}}},limit=1] run tellraw @a[tag=same_room] {type:"translatable",translate:"chat.type.text",with:[{type:"selector",selector:"@a[tag=scanning_player,limit=1]",color:"green"},{type:"translatable",translate:"luigis_mansion:message.player.scan_furniture.115",with:[{type:"nbt",entity:"@e[tag=scanned_entity,limit=1]",nbt:"data.player_name"}]}]}
execute if score #dialog Dialog matches 1 if score #temp Variant matches 3 run tellraw @a[tag=same_room] {type:"translatable",translate:"chat.type.text",with:[{type:"selector",selector:"@a[tag=scanning_player,limit=1]",color:"green"},{type:"translatable",translate:"luigis_mansion:message.player.scan_furniture.116",with:[{type:"nbt",entity:"@e[tag=scanned_entity,limit=1]",nbt:"data.player_name"}]}]}
execute if score #dialog Dialog matches 1 at @e[tag=scanned_entity,scores={Health=51..},tag=flashlight_selected,limit=1] positioned ~ ~-1.4 ~ unless entity @e[distance=..5,tag=item,nbt={data:{item:{namespace:"luigis_mansion",id:"gold_coin"}}},limit=1] run tellraw @a[tag=same_room] {type:"translatable",translate:"chat.type.text",with:[{type:"selector",selector:"@a[tag=scanning_player,limit=1]",color:"green"},{type:"translatable",translate:"luigis_mansion:message.player.scan_furniture.117",with:[{type:"nbt",entity:"@e[tag=scanned_entity,limit=1]",nbt:"data.player_name"}]}]}
execute if score #dialog Dialog matches 1 if entity @e[tag=scanned_entity,scores={Health=31..50},limit=1] run tellraw @a[tag=same_room] {type:"translatable",translate:"chat.type.text",with:[{type:"selector",selector:"@a[tag=scanning_player,limit=1]",color:"green"},{type:"translatable",translate:"luigis_mansion:message.player.scan_furniture.118",with:[{type:"nbt",entity:"@e[tag=scanned_entity,limit=1]",nbt:"data.player_name"}]}]}
execute if score #dialog Dialog matches 1 if entity @e[tag=scanned_entity,scores={Health=11..30},limit=1] run tellraw @a[tag=same_room] {type:"translatable",translate:"chat.type.text",with:[{type:"selector",selector:"@a[tag=scanning_player,limit=1]",color:"green"},{type:"translatable",translate:"luigis_mansion:message.player.scan_furniture.119",with:[{type:"nbt",entity:"@e[tag=scanned_entity,limit=1]",nbt:"data.player_name"}]}]}
execute if score #dialog Dialog matches 1 if entity @e[tag=scanned_entity,scores={Health=1..10},limit=1] run tellraw @a[tag=same_room] {type:"translatable",translate:"chat.type.text",with:[{type:"selector",selector:"@a[tag=scanning_player,limit=1]",color:"green"},{type:"translatable",translate:"luigis_mansion:message.player.scan_furniture.120",with:[{type:"nbt",entity:"@e[tag=scanned_entity,limit=1]",nbt:"data.player_name"}]}]}
execute if score #dialog Dialog matches 1 at @e[tag=scanned_entity,scores={Health=51..},limit=1] positioned ~ ~-1.4 ~ if entity @e[distance=..5,tag=item,nbt={data:{item:{namespace:"luigis_mansion",id:"gold_coin"}}},limit=1] run tellraw @a[tag=same_room] {type:"translatable",translate:"chat.type.text",with:[{type:"selector",selector:"@a[tag=scanning_player,limit=1]",color:"green"},{type:"translatable",translate:"luigis_mansion:message.player.scan_furniture.121",with:[{type:"nbt",entity:"@e[tag=scanned_entity,limit=1]",nbt:"data.player_name"}]}]}
execute if score #dialog Dialog matches 1 at @e[tag=scanned_entity,scores={Health=51..},tag=game_boy_horror_selected,limit=1] positioned ~ ~-1.4 ~ unless entity @e[distance=..5,tag=item,nbt={data:{item:{namespace:"luigis_mansion",id:"gold_coin"}}},limit=1] run tellraw @a[tag=same_room] {type:"translatable",translate:"chat.type.text",with:[{type:"selector",selector:"@a[tag=scanning_player,limit=1]",color:"green"},{type:"translatable",translate:"luigis_mansion:message.player.scan_furniture.122",with:[{type:"nbt",entity:"@e[tag=scanned_entity,limit=1]",nbt:"data.player_name"}]}]}
execute if score #dialog Dialog matches 1 as @e[tag=scanned_entity,scores={Health=51..},limit=1] unless entity @s[tag=!catch_portrait_ghost,tag=!catch_ghost] at @s positioned ~ ~-1.4 ~ unless entity @e[distance=..5,tag=item,nbt={data:{item:{namespace:"luigis_mansion",id:"gold_coin"}}},limit=1] run tellraw @a[tag=same_room] {type:"translatable",translate:"chat.type.text",with:[{type:"selector",selector:"@a[tag=scanning_player,limit=1]",color:"green"},{type:"translatable",translate:"luigis_mansion:message.player.scan_furniture.123",with:[{type:"nbt",entity:"@e[tag=scanned_entity,limit=1]",nbt:"data.player_name"}]}]}
execute if score #dialog Dialog matches 1 as @e[tag=scanned_entity,limit=1] unless entity @s[scores={Health=1..}] run tellraw @a[tag=same_room] {type:"translatable",translate:"chat.type.text",with:[{type:"selector",selector:"@a[tag=scanning_player,limit=1]",color:"green"},{type:"translatable",translate:"luigis_mansion:message.player.scan_furniture.134",with:[{type:"nbt",entity:"@e[tag=scanned_entity,limit=1]",nbt:"data.player_name"}]}]}
scoreboard players reset #temp Variant

execute if score #dialog Dialog matches 3 if entity @a[tag=same_room,tag=next_dialog_line,limit=1] as @e[tag=scanned_entity,limit=1] unless entity @s[scores={Health=1..}] run tellraw @a[tag=same_room] {type:"translatable",translate:"chat.type.text",with:[{type:"selector",selector:"@a[tag=scanning_player,limit=1]",color:"green"},{type:"translatable",translate:"luigis_mansion:message.player.scan_furniture.135",with:[{type:"nbt",entity:"@e[tag=scanned_entity,limit=1]",nbt:"data.player_name"}]}]}
execute if score #dialog Dialog matches 3 if entity @e[tag=scanned_entity,scores={Health=1..},limit=1] as @a[tag=same_room,tag=dialog_menu] run function luigis_mansion:selection_menu/dialog/exit
execute if score #dialog Dialog matches 3 if entity @e[tag=scanned_entity,scores={Health=1..},limit=1] run scoreboard players set #dialog Dialog -1

execute if score #dialog Dialog matches 4 run scoreboard players set #dialog Dialog -1

execute if score #dialog Dialog matches -1 as @e[tag=luigi,tag=!scanning_player,tag=same_room] run function luigis_mansion:entities/luigi/animation/set/none

execute if score #dialog Dialog matches -1 as @a[tag=scanning_player,limit=1] run function luigis_mansion:selection_menu/game_boy_horror/scan_furniture
tag @e remove scanning_player
tag @e remove scanned_entity
